# CI/CD Pipeline –¥–ª—è Flow Logic
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç GitHub Personal Access Token –¥–ª—è —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º cache, —Ç–∞–∫ –∫–∞–∫ package-lock.json –≤ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö
      
      - name: Check project structure
        run: |
          echo "üìÅ Project structure:"
          ls -la src/ 2>/dev/null || echo "‚ö†Ô∏è  src/ directory not found"
          echo ""
          echo "Backend:"
          ls -la src/backend/ 2>/dev/null | head -5 || echo "‚ö†Ô∏è  src/backend/ not found"
          echo ""
          echo "Frontend:"
          ls -la src/frontend/ 2>/dev/null | head -5 || echo "‚ö†Ô∏è  src/frontend/ not found"
      
      - name: Install dependencies (Backend)
        run: |
          if [ -f "src/backend/package.json" ]; then
            echo "üì¶ Installing backend dependencies..."
            cd src/backend
            if [ -f "package-lock.json" ]; then
              npm ci || {
                echo "‚ö†Ô∏è  npm ci failed, trying npm install..."
                npm install
              }
            else
              echo "‚ö†Ô∏è  package-lock.json not found, using npm install"
              npm install
            fi
            echo "‚úÖ Backend dependencies installed"
          else
            echo "‚ö†Ô∏è  Backend package.json not found, skipping..."
          fi
      
      - name: Install dependencies (Frontend)
        run: |
          if [ -f "src/frontend/package.json" ]; then
            echo "üì¶ Installing frontend dependencies..."
            cd src/frontend
            if [ -f "package-lock.json" ]; then
              npm ci || {
                echo "‚ö†Ô∏è  npm ci failed, trying npm install..."
                npm install
              }
            else
              echo "‚ö†Ô∏è  package-lock.json not found, using npm install"
              npm install
            fi
            echo "‚úÖ Frontend dependencies installed"
          else
            echo "‚ö†Ô∏è  Frontend package.json not found, skipping..."
          fi
      
      - name: Build Backend
        run: |
          if [ -f "src/backend/package.json" ] && [ -f "src/backend/tsconfig.json" ]; then
            echo "üì¶ Building backend..."
            echo "üìÅ Current directory: $(pwd)"
            echo "üìÅ Checking config files:"
            ls -la src/backend/config/*.ts || echo "‚ö†Ô∏è  Config files not found"
            cd src/backend
            echo "üìÅ In backend directory: $(pwd)"
            echo "üìÅ Config files here:"
            ls -la config/*.ts || echo "‚ö†Ô∏è  Config files not found in backend/"
            npm run build || {
              echo "‚ùå Backend build failed"
              exit 1
            }
            echo "‚úÖ Backend build successful"
          else
            echo "‚ö†Ô∏è  Backend not found or not configured, skipping build..."
          fi
      
      - name: Build Frontend
        run: |
          if [ -f "src/frontend/package.json" ]; then
            echo "üì¶ Building frontend..."
            cd src/frontend
            npm run build || {
              echo "‚ùå Frontend build failed"
              exit 1
            }
            echo "‚úÖ Frontend build successful"
          else
            echo "‚ö†Ô∏è  Frontend not found or not configured, skipping build..."
          fi
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || 'https://api.flowlogic.shop' }}
      
      - name: Run tests
        if: hashFiles('src/backend/package.json') != ''
        run: |
          cd src/backend
          npm test -- --coverage || true
        continue-on-error: true

  deploy-staging:
    name: Deploy to Staging
    needs: build
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Deploy Backend (Serverless)
        run: |
          if [ -d "infra/serverless" ]; then
            cd infra/serverless
            echo "üì¶ Installing Serverless Framework..."
            npm install -g serverless@latest
            echo "üì¶ Installing dependencies..."
            npm install
            echo "üöÄ Deploying to staging..."
            serverless deploy --stage staging
          else
            echo "‚ö†Ô∏è  infra/serverless directory not found, skipping deployment"
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Deploy Frontend (Vercel)
        run: |
          cd src/frontend
          npm install -g vercel
          vercel deploy --prebuilt --prod
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  deploy-production:
    name: Deploy to Production
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Deploy Backend (Serverless)
        run: |
          if [ -d "infra/serverless" ]; then
            cd infra/serverless
            echo "üì¶ Installing Serverless Framework..."
            npm install -g serverless@latest || {
              echo "‚ö†Ô∏è  Failed to install serverless globally, trying local install..."
              npm install serverless --save-dev
            }
            echo "üì¶ Installing dependencies..."
            npm install
            echo "üìÅ Current directory: $(pwd)"
            echo "üìÅ Checking serverless.yml..."
            if [ -f "serverless.yml" ]; then
              echo "‚úÖ serverless.yml found"
            else
              echo "‚ùå serverless.yml not found!"
              exit 1
            fi
            echo "üöÄ Deploying to production..."
            npx serverless deploy --stage production || {
              echo "‚ùå Deployment failed"
              exit 1
            }
          else
            echo "‚ö†Ô∏è  infra/serverless directory not found, skipping deployment"
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Deploy Frontend (Vercel)
        run: |
          cd src/frontend
          npm install -g vercel
          vercel deploy --prebuilt --prod
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  agent-workflow:
    name: Agent Workflow (GitHub API)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[AGENT]')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python (–¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install PyGithub
      
      - name: Use GitHub token for GitHub API calls
        env:
          # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–º–µ–Ω–∏ —Å–µ–∫—Ä–µ—Ç–∞
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "‚úÖ Using GitHub token for authentication"
          echo "Token format: ${GITHUB_TOKEN:0:7}...${GITHUB_TOKEN: -4}"
          
          # –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub API
          python3 << 'EOF'
          import os
          from github import Github
          
          token = os.getenv('GITHUB_TOKEN')
          if not token:
              print("‚ùå GITHUB_TOKEN not set")
              exit(1)
          
          try:
              g = Github(token)
              user = g.get_user()
              print(f"‚úÖ Connected to GitHub as: {user.login}")
              
              # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
              repo = g.get_repo("recreomassage-hub/flowlogic.shop")
              print(f"‚úÖ Repository: {repo.full_name}")
              print(f"   Description: {repo.description or 'N/A'}")
              print(f"   Status: {'Private' if repo.private else 'Public'}")
              
              # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–º–º–∏—Ç–æ–≤
              commits = list(repo.get_commits()[:5])
              print(f"\nüìù Last 5 commits:")
              for commit in commits:
                  msg = commit.commit.message.split('\n')[0]
                  print(f"   - {commit.sha[:7]}: {msg}")
              
          except Exception as e:
              print(f"‚ùå Error: {e}")
              exit(1)
          EOF
      
      - name: Agent operations
        env:
          # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–º–µ–Ω–∏ —Å–µ–∫—Ä–µ—Ç–∞
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_REPO: recreomassage-hub/flowlogic.shop
        run: |
          echo "ü§ñ Agent operations can use GITHUB_TOKEN here"
          # –ü—Ä–∏–º–µ—Ä: —Å–æ–∑–¥–∞–Ω–∏–µ issue, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø—Ä–æ–≤–µ—Ä–∫–∞ PR –∏ —Ç.–¥.

