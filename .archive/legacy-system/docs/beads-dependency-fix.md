# Исправление системы зависимостей в Beads CLI

## Проблема

Команда `bd ready` не работала корректно для управления графом задач (порядком выполнения). Задачи с зависимостями (`blocked_by`) не показывались как готовые, даже если все блокирующие задачи были завершены.

### Причина

В исходной реализации команды `ready` проверялось только наличие поля `blocked_by`, но **не проверялся статус блокирующих задач**:

```bash
# Старая логика (неправильная)
blocked_by=$(echo "$line" | jq -r '.blocked_by[]? // empty' 2>/dev/null || echo "")
if [ "$status" = "ready" ] && [ -z "$blocked_by" ]; then
  echo "$line"  # Показывать только задачи без блокировок
fi
```

**Проблема:** Задача DS-4 заблокирована DS-1, но даже когда DS-1 завершена (`status="done"`), DS-4 не показывалась как готовая, потому что проверялось только наличие `blocked_by`, а не статус блокирующих задач.

## Решение

Исправлена логика проверки зависимостей:

1. **Задача готова, если:**
   - Статус = `ready` **И**
   - (Нет блокировок **ИЛИ** все блокирующие задачи имеют статус `done`)

2. **Реализация:**
   ```bash
   # Новая логика (правильная)
   blocked_by_count=$(echo "$line" | jq -r '(.blocked_by // []) | length')
   
   if [ "$blocked_by_count" -eq 0 ]; then
     # Нет блокировок - задача готова
     echo "$line"
   else
     # Проверить статус всех блокирующих задач
     all_done=true
     for blocker_id in $(echo "$line" | jq -r '.blocked_by[]?'); do
       blocker_status=$(echo "$all_issues" | jq -r ".[] | select(.id == \"$blocker_id\") | .status")
       if [ "$blocker_status" != "done" ]; then
         all_done=false
         break
       fi
     done
     
     if [ "$all_done" = true ]; then
       echo "$line"  # Все блокирующие задачи завершены - задача готова
     fi
   fi
   ```

## Результат

Теперь команда `bd ready` корректно показывает:

- ✅ Задачи без зависимостей (всегда готовы, если `status="ready"`)
- ✅ Задачи с зависимостями, где все блокирующие задачи завершены (`status="done"`)
- ❌ Задачи с незавершенными зависимостями (не показываются)

### Пример

**До исправления:**
```bash
$ bd ready
[2] DS-14: Final Visual Regression Testing (est: 2h)
# DS-4, DS-5, DS-6 не показывались, хотя DS-1 завершена
```

**После исправления:**
```bash
$ bd ready
[1] DS-4: Create Typography Components (est: 1h)
[1] DS-5: Create Input Component (est: 2h)
[1] DS-6: Create Modal Component (est: 2h)
[2] DS-14: Final Visual Regression Testing (est: 2h)
# DS-4, DS-5, DS-6 показываются, т.к. DS-1 завершена
```

## Технические детали

### Изменения в `scripts/bd.sh`

1. **Добавлена функция `read_issues_json()`** - читает все задачи как JSON массив для проверки зависимостей
2. **Улучшена команда `ready`** - теперь проверяет статус блокирующих задач
3. **Добавлена валидация** - проверка, что `blocked_by_count` является числом

### Файлы изменены

- `scripts/bd.sh` - исправлена логика команды `ready`

## Использование

Теперь граф задач работает корректно:

```bash
# Показать готовые задачи (с учетом зависимостей)
bd ready

# Показать готовые задачи в JSON формате
bd ready --json

# Начать работу над задачей
bd start DS-4

# Завершить задачу (разблокирует зависимые задачи)
bd complete DS-4
```

## Проверка работы

```bash
# Проверить зависимости задачи
bd show DS-4 | jq '{id, blocked_by, status}'

# Проверить статус блокирующей задачи
bd show DS-1 | jq '{id, status}'

# Показать готовые задачи
bd ready
```

---

**Дата исправления:** 2026-01-09  
**Версия:** 1.1

