#!/bin/bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ Beads
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Beads, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

set -e

echo "üîç –ü–æ–∏—Å–∫ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Beads"
echo "=========================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Go
if ! command -v go &> /dev/null; then
    echo "‚ö†Ô∏è  Go –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo ""
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Go (Ubuntu/Debian):"
    echo "  sudo apt update"
    echo "  sudo apt install golang-go"
    echo ""
    echo "–ò–ª–∏ —á–µ—Ä–µ–∑ snap:"
    echo "  sudo snap install go --classic"
    echo ""
    read -p "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Go —Å–µ–π—á–∞—Å? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        sudo apt update
        sudo apt install -y golang-go
    else
        echo "‚ùå –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Go –≤—Ä—É—á–Ω—É—é."
        exit 1
    fi
fi

echo "‚úÖ Go —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(go version)"
echo ""

# –ü–æ–∏—Å–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Beads
echo "üîç –ü–æ–∏—Å–∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Beads..."
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Beads –Ω–µ —É–∫–∞–∑–∞–Ω –≤ —Å—Ç–∞—Ç—å–µ."
echo "   –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –µ–≥–æ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–∏."
echo ""

# –í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
REPOS=(
    "beads-dev/beads"
    "steveyegge/beads"
    "beads/beads"
    "beads-tracker/beads"
    "sourcegraph/beads"
)

REPO_FOUND=""
for repo in "${REPOS[@]}"; do
    echo "–ü—Ä–æ–≤–µ—Ä–∫–∞: https://github.com/$repo"
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://github.com/$repo" 2>/dev/null || echo "000")
    if [ "$HTTP_CODE" = "200" ]; then
        REPO_FOUND="$repo"
        echo "‚úÖ –ù–∞–π–¥–µ–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $repo"
        break
    fi
done

if [ -z "$REPO_FOUND" ]; then
    echo ""
    echo "‚ùå –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
    echo ""
    echo "–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π:"
    echo "1. –ù–∞–π—Ç–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤—Ä—É—á–Ω—É—é:"
    echo "   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GitHub –∞–∫–∫–∞—É–Ω—Ç –°—Ç–∏–≤–∞ –ô–µ–≥–≥–µ"
    echo "   - –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º: 'beads issue tracker go'"
    echo "   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Å—ã–ª–∫–∏ –≤ —Å—Ç–∞—Ç—å–µ –Ω–∞ Habr"
    echo ""
    echo "2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±:"
    echo "   - Pre-built binary (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)"
    echo "   - –ß–µ—Ä–µ–∑ –ø–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)"
    echo ""
    echo "3. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —Ç–µ–∫—É—â–∏–º bd.sh:"
    echo "   - –í–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Å–ª–µ–¥—É–µ—Ç —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏ Beads"
    echo "   - –ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π bd.sh"
    echo ""
    read -p "–£–∫–∞–∑–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤—Ä—É—á–Ω—É—é? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo ""
        echo "–§–æ—Ä–º–∞—Ç: owner/repo (–Ω–∞–ø—Ä–∏–º–µ—Ä: beads-dev/beads)"
        read -p "GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: " REPO_FOUND
    else
        echo ""
        echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å bd.sh"
        echo "   –í–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ —É–∂–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é Beads –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."
        echo "   –ú–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Beads –ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ –Ω–∞–π–¥–µ—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π."
        exit 0
    fi
fi

if [ -z "$REPO_FOUND" ]; then
    echo "‚ùå –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ —É–∫–∞–∑–∞–Ω. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞."
    exit 1
fi

echo ""
echo "üì¶ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"

git clone "https://github.com/$REPO_FOUND.git" beads-install
cd beads-install

echo ""
echo "üî® –°–±–æ—Ä–∫–∞ Beads..."
if [ -f "go.mod" ]; then
    go build -o beads .
    echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞
    echo ""
    echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Beads..."
    sudo cp beads /usr/local/bin/beads
    sudo chmod +x /usr/local/bin/beads
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞
    echo ""
    echo "‚úÖ Beads —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo ""
    beads --version || beads version || echo "–ö–æ–º–∞–Ω–¥–∞ beads –¥–æ—Å—Ç—É–ø–Ω–∞"
    
    # –û—á–∏—Å—Ç–∫–∞
    cd /
    rm -rf "$TEMP_DIR"
    
    echo ""
    echo "üéâ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  beads --help"
    echo "  beads init"
    echo ""
else
    echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω go.mod. –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –Ω–µ Go –ø—Ä–æ–µ–∫—Ç."
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤—Ä—É—á–Ω—É—é: https://github.com/$REPO_FOUND"
    exit 1
fi

